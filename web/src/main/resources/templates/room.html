<!DOCTYPE html>
<html lang="ch" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="快艇骰子-房间号+${session.room.roomId}">Title</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="/bootstrap-3.4.1-dist/js/stomp.js"></script>
    <script src="/bootstrap-3.4.1-dist/js/jquery-3.6.0.min.js"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="/bootstrap-3.4.1-dist/js/bootstrap.min.js"></script>
    <script src="/bootstrap-3.4.1-dist/js/template.js"></script>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="/bootstrap-3.4.1-dist/css/bootstrap.min.css">
    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="/bootstrap-3.4.1-dist/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/bootstrap-3.4.1-dist/css/all.min.css">
    <link rel="stylesheet" href="/bootstrap-3.4.1-dist/css/quick-website.css">
    <script type="text/html" id="seat-html" th:inline="javascript">
        <!-- Card -->
        <div class="col-md-2">
            <div class="card" id="{{content.id}}">
                <div class="card-body pb-1">
                    <div class="pt-1 pb-1">
                        <img id="img-{{content.id}}" src="/bootstrap-3.4.1-dist/images/umr.webp" class="img-fluid img-center" style="height: 100px;" alt="头像">
                    </div>
                    <h5 class="h4 lh-130 mb-1 text-center">{{content.user.realname}}</h5>
                    <p class="text-muted mb-0 text-center">
                        历史最高分：{{content.user.historyRankVO.bestScore}}
                        <br>
                        胜率：{{content.user.historyRankVO.winPercent}}%  总局数：{{content.user.historyRankVO.playCount}}
                    </p>
                </div>
            </div>
        </div>
    </script>
    <script type="text/html" id="pre-half-html" th:inline="javascript">
        <tr class="table-success">
            <td style="text-align: center; font-weight: bold;" colspan="2">{{user.realname}}</td>
            <td id="one-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="two-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="three-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="four-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="five-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="six-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="smallSum-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">0/63</td>
        </tr>
    </script>
    <script type="text/html" id="post-half-html" th:inline="javascript">
        <tr class="table-success">
            <td style="text-align: center; font-weight: bold;" colspan="2">{{user.realname}}</td>
            <td id="sum-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="kind4-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="fullHouse-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="smallStraight-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="straight-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="yahtzee-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">-</td>
            <td id="totalSum-{{user.username}}" style="text-align: center; font-weight: bold;" colspan="2">0</td>
        </tr>
    </script>
    <script type="text/javascript" th:inline="javascript">
        var stompClient = null;
        var scoreIdList = ['one','two','three','four','five','six','sum'
            ,'kind4','fullHouse','smallStraight','straight','yahtzee','smallSum','bonus','totalSum'];
        var playerScoreIdList = [];

        var diceIdList = ['number1','number2','number3','number4','number5'];

        var lockDiceIndexList = [-1,-1,-1,-1,-1];

        var messageId = null;

        var dicePicList = ['/bootstrap-3.4.1-dist/images/一点.png','/bootstrap-3.4.1-dist/images/二点.png',
            '/bootstrap-3.4.1-dist/images/三点.png','/bootstrap-3.4.1-dist/images/四点.png',
            '/bootstrap-3.4.1-dist/images/五点.png','/bootstrap-3.4.1-dist/images/六点.png'];

        var diceTaskId = null;

        function connect() {
            var socket = new SockJS([[${session.wsUrl}]]);
            stompClient = Stomp.over(socket);
            stompClient.connect({"user": JSON.stringify([[${session.user}]]),'room': JSON.stringify([[${session.room}]])}, function (frame) {
                //setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/'+[[${session.room.roomId}]], function (response) {
                    var parse = JSON.parse(response.body);
                    if(messageId == null || messageId < parse.id){
                        messageId = parse.id;
                    }
                    if(parse.reconnectUserId === null || parse.reconnectUserId === [[${session.user.id}]]){
                        //坐下，显示玩家的信息
                        if(parse.code === 102){
                            document.getElementById("seat_list").innerHTML += template("seat-html", {content:parse.content});
                            if(parse.content.user.id != [[${session.user.id}]]){
                                document.getElementById("pre-half").innerHTML += template("pre-half-html",{user:parse.content.user});
                                document.getElementById("post-half").innerHTML += template("post-half-html",{user:parse.content.user});
                                var idList = [];
                                for(var i=0; i<scoreIdList.length; i++){
                                    idList.push(scoreIdList[i] + "-" + parse.content.user.username);
                                }
                                playerScoreIdList.push(idList);
                            } else {
                                var idList = [];
                                for(var i=0; i<scoreIdList.length; i++){
                                    idList.push(scoreIdList[i] + "-my");
                                }
                                playerScoreIdList.push(idList);
                            }
                        }
                        var ids = playerScoreIdList[parse.seat];
                        var playDice = document.getElementById("playDice");
                        //收到广播开始游戏
                        if(parse.code === 104){

                        }
                        //收到抛出骰子的结果，需要填入到各项中
                        if(parse.code === 4){
                            setTimeout(()=>{
                                clearInterval(diceTaskId);
                                document.getElementById('number1').src = dicePicList[parse.content.numbers[0]-1];
                                document.getElementById('number2').src = dicePicList[parse.content.numbers[1]-1];
                                document.getElementById('number3').src = dicePicList[parse.content.numbers[2]-1];
                                document.getElementById('number4').src = dicePicList[parse.content.numbers[3]-1];
                                document.getElementById('number5').src = dicePicList[parse.content.numbers[4]-1];
                                for (var i=0;i<parse.content.scores.length;i++)
                                {
                                    var elementById1 = document.getElementById(ids[i]);
                                    if(parse.content.haveScores[i] === -1){
                                        elementById1.innerHTML = parse.content.scores[i];
                                        elementById1.style.color = "red";
                                    } else {
                                        elementById1.innerHTML = parse.content.haveScores[i];
                                    }
                                }
                                if(parse.content.haveScores[13] === 35){
                                    document.getElementById(ids[12]).innerText = "✓";
                                } else {
                                    document.getElementById(ids[12]).innerText = parse.content.haveScores[12] + "/63";
                                }
                                document.getElementById(ids[14]).innerText = parse.content.haveScores[14];
                                playDice.innerText = "投掷骰子*" + parse.content.times;
                            },1500);
                        }
                        //收到广播的选择分数结果
                        if(parse.code === 5){
                            resetDice();
                            for (var i=0;i<parse.content.length;i++)
                            {
                                //13奖励分不填出来
                                if(i != 13){
                                    var elementById1 = document.getElementById(ids[i]);
                                    elementById1.style.color = "black";
                                    if(parse.content[i] === -1){
                                        elementById1.innerHTML = "-";
                                    } else {
                                        if(i === 12){
                                            if(parse.content[13] === 35){
                                                elementById1.innerHTML = parse.content[i] + "✓";
                                            } else {
                                                elementById1.innerHTML = parse.content[i] + "/63";
                                            }
                                        } else {
                                            elementById1.innerHTML = parse.content[i];
                                        }
                                    }
                                }
                            }
                        }
                        //收到游戏结束
                        if(parse.code === 111){
                            if(parse.content.winner != null){
                                alert("赢家为"+parse.content.winner.user.realname+"！");
                            } else {
                                alert("平局！");
                            }
                            window.location.href = '/';
                        }
                        //收到解散消息
                        if(parse.code === 109){
                            alert("房间已解散!")
                            window.location.href = '/';
                        }
                        //收到超时
                        if(parse.code === 113){
                            alert("房间超时已解散!")
                            window.location.href = '/';
                        }
                        //收到换人play的消息
                        if(parse.code === 105){
                            for (let i = 0; i < parse.content; i++) {
                                document.getElementById(i.toString()).style.backgroundColor = "#FFF";
                            }
                            document.getElementById(parse.seat.toString()).style.backgroundColor = "#FFEEBB";
                            resetDice();
                            disable();
                        }
                        //收到有人断线的消息
                        if(parse.code === 107){
                            document.getElementById("img-"+parse.seat).style.filter = "grayscale(100%)";
                        }
                        //收到有人在线的消息
                        if(parse.code === 108){
                            document.getElementById("img-"+parse.seat).style.filter = "";
                        }
                        //收到有人投骰子，展示动画
                        if(parse.code === 3){
                            lockDiceIndexList = parse.content;
                            let j = 0;
                            diceTaskId = setInterval(function (){
                                for (let i = 0; i < diceIdList.length; i++) {
                                    if(lockDiceIndexList[i] === -1){
                                        document.getElementById(diceIdList[i]).src = dicePicList[j];
                                        if(i % 2 === 0){
                                            document.getElementById(diceIdList[i]).src = dicePicList[j];
                                        } else {
                                            document.getElementById(diceIdList[i]).src = dicePicList[dicePicList.length - 1 - j];
                                        }
                                    }
                                }
                                if(j === dicePicList.length -1){
                                    j = 0;
                                } else {
                                    j++;
                                }
                            },50);
                        }
                        //收到锁骰子的广播，展示
                        if(parse.code === 7){
                            lockDiceIndexList = parse.content;
                            for (let i = 0; i < lockDiceIndexList.length; i++) {
                                var dice = document.getElementById(diceIdList[i]);
                                if(lockDiceIndexList[i] === 1){
                                    dice.classList.add("img-select");
                                } else {
                                    dice.classList.remove("img-select");
                                }
                            }
                        }
                    }
                });
                stompClient.subscribe('/user/'+[[${session.user.id}]]+'/'+[[${session.room.roomId}]], function (response){
                    var parse = JSON.parse(response.body);
                    if(messageId == null || messageId < parse.id){
                        messageId = parse.id;
                    }
                    var playDice = document.getElementById("playDice");
                    //询问开始游戏
                    if(parse.code === 104){
                        document.getElementById("start-game").disabled = false;
                    }
                    //询问投骰子还是选择分数
                    if(parse.code === 6){
                        var times = parse.content.times;
                        playDice.disabled = times === 0;
                        playDice.innerText = "投掷骰子*" + times;
                        if(times != 3){
                            var haveScores = parse.content.haveScores;
                            for (var i=0; i < 12; i++) {
                                if(haveScores[i] === -1){
                                    selectScore(i, playerScoreIdList[parse.seat][i], parse.seat);
                                }
                            }
                            for (var i=0; i < diceIdList.length; i++){
                                lockDice(i,diceIdList[i]);
                            }
                        }
                    }
                })
            },{});
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            //setConnected(false);
            console.log("Disconnected");
        }

        function playDice() {
            var playDice = document.getElementById("playDice");
            playDice.disabled = true;
            stompClient.send("/command",{}, JSON.stringify({'id': messageId, 'code': 3 ,'content': lockDiceIndexList}));
        }

        function startGame(){
            document.getElementById("start-game").disabled = true;
            stompClient.send("/command",{}, JSON.stringify({'id': messageId, 'code': 104}));
        }

        function selectScore(index, id, seat){
            document.getElementById(id).onmousedown = function (){
                stompClient.send("/command",{}, JSON.stringify({'id': messageId, 'code': 5,'content': index}));
                for (var i=0;i < 12; i++)
                {
                    document.getElementById(playerScoreIdList[seat][i]).onmousedown = null;
                }
            }
        }

        function lockDice(index, id){
            var dice = document.getElementById(id);
            dice.onmousedown = function (){
                if(lockDiceIndexList[index] === -1){
                    lockDiceIndexList[index] = 1;
                } else {
                    lockDiceIndexList[index] = -1;
                }
                stompClient.send("/public",{}, JSON.stringify({"code": 7, 'content': lockDiceIndexList}));
            }
        }

        //处理不是自己回合时，禁止一些操作
        function disable(){
            //禁止锁定骰子
            for (let i = 0; i < diceIdList.length; i++) {
                document.getElementById(diceIdList[i]).onmousedown = null;
            }
        }

        function resetDice(){
            for (var i=0; i < diceIdList.length; i++) {
                var dice = document.getElementById(diceIdList[i]);
                dice.src = dicePicList[5];
                dice.classList.remove("img-select");
                lockDiceIndexList[i] = -1;
            }
        }

        function dismissRoom(){
            stompClient.send("/dismiss",{},
                JSON.stringify({'code': 109}));
        }
    </script>
    <style>
        .img-select {
            border:dashed 2px red;
            border-right:solid 2px red;
            border-top: solid 2px red;
            border-bottom: solid 2px red;
            border-left:  solid 2px red;
        }
    </style>
</head>
<body class="loaded" onload="connect()">
    <!-- Main content -->
    <section class="slice py-4">
        <div class="container">
            <div class="row row-grid align-items-center">
                <div class="col-12 col-md-5 col-lg-6 order-md-2 text-center">
                    <!-- Section title -->
                    <div class="row justify-content-center text-center">
                        <div>
                        <button id="start-game" onclick="startGame()" class="badge badge-soft-success badge-pill badge-lg" disabled>
                            开始游戏
                        </button>
                        <span onclick="dismissRoom()" class="badge badge-soft-success badge-pill badge-lg">
                            解散游戏
                        </span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-7 col-lg-6 order-md-1 pr-md-5">
                    <!-- Heading -->
                    <h1 class="display-4 text-center text-md-left">快艇骰子-房间号<strong th:text="${session.room.roomId}" class="text-primary">999999</strong>
                    </h1>
                </div>
            </div>
        </div>
    </section>
    <section class="slice slice-lg pt-lg-3 pb-lg-3 bg-section-secondary">
        <div class="container">
            <!-- Card -->
            <div id="seat_list" class="row">
                <!--添加座位框-->
            </div>
        </div>
    </section>
    <section class="slice slice-sm">
        <div class="container">
            <!--添加游戏主体 -->
            <div style="display: flex; justify-content: center">
                <div class="table-responsive">
                    <table class="table table-hover" style="text-align: center;table-layout:fixed;word-break:break-all;">
                        <thead class="table-warning">
                            <tr>
                                <th class="h4" style="text-align: center; font-weight: bold;" colspan="2">回合</th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_一点.png" style="height: 40px;" alt="一点"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_二点.png" style="height: 40px;" alt="二点"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_三点.png" style="height: 40px;" alt="三点"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_四点.png" style="height: 40px;" alt="四点"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_五点.png" style="height: 40px;" alt="五点"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_六点.png" style="height: 40px;" alt="六点"></th>
                                <th class="h4" style="text-align: center; font-weight: bold;" colspan="2">奖励+35</th>
                            </tr>
                        </thead>
                        <tbody id="pre-half">
                            <tr class="table-primary">
                                <td class="h4" style="text-align: center; font-weight: bold;" colspan="2">己方</td>
                                <td class="h4" id="one-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="two-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="three-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="four-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="five-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="six-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="smallSum-my" style="text-align: center; font-weight: bold;" colspan="2">0/63</td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-hover" style="text-align: center;table-layout:fixed;word-break:break-all;">
                        <thead class="table-warning">
                            <tr>
                                <th class="h4" style="text-align: center; font-weight: bold;" colspan="2">回合</th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_全选.png" style="height: 40px;" alt="全选"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_四条.png" style="height: 40px;" alt="四骰同花"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_葫芦.png" style="height: 40px;" alt="葫芦"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_小顺.png" style="height: 40px;" alt="小顺"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_大顺.png" style="height: 40px;" alt="大顺"></th>
                                <th style="text-align: center;" colspan="2"><img class="img-fluid" src="/bootstrap-3.4.1-dist/images/骰子_快艇.png" style="height: 40px;" alt="快艇"></th>
                                <th class="h4" style="text-align: center; font-weight: bold;" colspan="2">总计点数</th>
                            </tr>
                        </thead>
                        <tbody id="post-half">
                            <tr class="table-primary">
                                <td class="h4" style="text-align: center; font-weight: bold;" colspan="2">己方</td>
                                <td class="h4" id="sum-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="kind4-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="fullHouse-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="smallStraight-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="straight-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="yahtzee-my" style="text-align: center; font-weight: bold;" colspan="2">-</td>
                                <td class="h4" id="totalSum-my" style="text-align: center; font-weight: bold;" colspan="2">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="display: flex; justify-content: center; margin-top: 50px">
                <table border="0" cellspacing="0" width="300px;" style="text-align: center">
                    <tr>
                        <td style="text-align: center;" colspan="2"><img id="number1" class="img-fluid" src="/bootstrap-3.4.1-dist/images/六点.png" style="height: 40px;" alt="6"></td>
                        <td style="text-align: center;" colspan="2"><img id="number2" class="img-fluid" src="/bootstrap-3.4.1-dist/images/六点.png" style="height: 40px;" alt="6"></td>
                        <td style="text-align: center;" colspan="2"><img id="number3" class="img-fluid" src="/bootstrap-3.4.1-dist/images/六点.png" style="height: 40px;" alt="6"></td>
                        <td style="text-align: center;" colspan="2"><img id="number4" class="img-fluid" src="/bootstrap-3.4.1-dist/images/六点.png" style="height: 40px;" alt="6"></td>
                        <td style="text-align: center;" colspan="2"><img id="number5" class="img-fluid" src="/bootstrap-3.4.1-dist/images/六点.png" style="height: 40px;" alt="6"></td>
                    </tr>
                </table>
                <button id="playDice" onclick="playDice()" class="badge badge-soft-success badge-pill badge-lg" disabled>
                    投掷骰子
                </button>
            </div>
        </div>
    </section>
</body>
</html>